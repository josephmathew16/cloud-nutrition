<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nutritional Insights – Cloud Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, Arial, sans-serif;
      background: #f4f5f8;
      color: #111827;
    }

    header.hero {
      background: #2563eb;
      color: #ffffff;
      padding: 18px 32px;
      font-size: 1.5rem;
      font-weight: 600;
    }

    main.page {
      padding: 24px 32px 40px;
      max-width: 1200px;
      margin: 0 auto;
    }

    h2.section-title {
      font-size: 1.35rem;
      margin-bottom: 12px;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 16px 16px 12px;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06);
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 190px;
    }

    .card h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
    }

    .card p {
      margin: 0;
      font-size: 0.9rem;
      color: #4b5563;
    }

    canvas {
      margin-top: 8px;
      max-width: 100%;
    }

    section.block {
      margin-bottom: 28px;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .filters-row input,
    .filters-row select {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.95rem;
      min-width: 180px;
      background: #ffffff;
    }

    .api-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
      margin-bottom: 8px;
    }

    .btn {
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      font-size: 0.95rem;
      cursor: pointer;
      color: #ffffff;
      transition: transform 0.05s ease, box-shadow 0.05s ease;
    }

    .btn-primary {
      background: #2563eb;
    }

    .btn-green {
      background: #059669;
    }

    .btn-purple {
      background: #7c3aed;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.15);
    }

    #meta {
      font-size: 0.85rem;
      color: #4b5563;
      margin-top: 4px;
    }

    .pagination {
      display: inline-flex;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #d1d5db;
    }

    .pagination button {
      border: none;
      padding: 6px 14px;
      background: #f9fafb;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .pagination button + button {
      border-left: 1px solid #e5e7eb;
    }

    .pagination .active {
      background: #2563eb;
      color: #ffffff;
    }

    details {
      background: #ffffff;
      border-radius: 12px;
      padding: 10px 14px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.05);
      font-size: 0.9rem;
    }

    details summary {
      cursor: pointer;
      font-weight: 500;
      list-style: none;
    }

    pre {
      margin-top: 8px;
      max-height: 260px;
      overflow: auto;
      background: #f9fafb;
      padding: 10px;
      border-radius: 8px;
      font-size: 0.8rem;
    }

    footer {
      text-align: center;
      padding: 14px 8px 18px;
      font-size: 0.8rem;
      background: #2563eb;
      color: #e5e7eb;
    }

    @media (max-width: 640px) {
      header.hero {
        padding: 14px 16px;
      }
      main.page {
        padding: 16px;
      }
    }
  </style>
</head>
<body>
  <header class="hero">
    Nutritional Insights
  </header>

  <main class="page">
    <!-- Explore Nutritional Insights -->
    <section class="block">
      <h2 class="section-title">Explore Nutritional Insights</h2>
      <div class="card-grid">
        <article class="card">
          <h3>Bar Chart</h3>
          <p>Average macronutrient content by diet type.</p>
          <canvas id="barChart" height="140"></canvas>
        </article>

        <article class="card">
          <h3>Scatter Plot</h3>
          <p>Nutrient relationships (e.g., protein vs carbs).</p>
          <canvas id="scatterChart" height="140"></canvas>
        </article>

        <article class="card">
          <h3>Heatmap</h3>
          <p>Nutrient correlations.</p>
          <canvas id="heatmapChart" height="140"></canvas>
        </article>

        <article class="card">
          <h3>Pie Chart</h3>
          <p>Recipe distribution by diet type.</p>
          <canvas id="pieChart" height="140"></canvas>
        </article>
      </div>
    </section>

    <!-- Filters and Data Interaction -->
    <section class="block">
      <h2 class="section-title">Filters and Data Interaction</h2>
      <div class="filters-row">
        <input
          id="dietSearch"
          type="text"
          placeholder="Search by Diet Type"
          aria-label="Search by Diet Type"
        />
        <select id="dietFilter" aria-label="Diet type filter">
          <option value="all">All Diet Types</option>
        </select>
      </div>
    </section>

    <!-- API Data Interaction -->
    <section class="block">
      <h2 class="section-title">API Data Interaction</h2>
      <div class="api-buttons">
        <button class="btn btn-primary" id="btnInsights">
          Get Nutritional Insights
        </button>
        <button class="btn btn-green" id="btnRecipes">
          Get Recipes
        </button>
        <button class="btn btn-purple" id="btnClusters">
          Get Clusters
        </button>
      </div>
      <div id="meta"></div>
    </section>

    <!-- Pagination -->
    <section class="block">
      <h2 class="section-title">Pagination</h2>
      <div class="pagination">
        <button id="pagePrev">Previous</button>
        <button class="page-number active" data-page="1">1</button>
        <button class="page-number" data-page="2">2</button>
        <button id="pageNext">Next</button>
      </div>
    </section>

    <!-- Raw JSON (kept for debugging / demo) -->
    <section class="block">
      <details>
        <summary>Raw JSON preview</summary>
        <pre id="jsonBox"></pre>
      </details>
    </section>
  </main>

  <footer>
    © 2025 Nutritional Insights. All Rights Reserved.
  </footer>

  <!-- Main dashboard script – uses the same helpers Nara created -->
  <script type="module">
    import { getDietInsights } from "./src/api/fetchData.js";
    import { toChartSeries, filterByDiet } from "./src/utils/transformData.js";

    let barChart, scatterChart, heatmapChart, pieChart;
    let fullPayload = null;
    let currentPage = 1;

    // ---------------------------
    // Data loading + filtering
    // ---------------------------
    async function loadData() {
      try {
        const payload = await getDietInsights(); // { datasetName, fetchedAt, records }
        fullPayload = payload;

        // Populate dropdown once
        const dietFilter = document.getElementById("dietFilter");
        if (dietFilter.options.length === 1) {
          const uniqueDiets = [...new Set(payload.records.map(r => r.Diet_type))]
            .filter(Boolean)
            .sort();

          uniqueDiets.forEach(d => {
            const opt = document.createElement("option");
            opt.value = d;
            opt.textContent = d;
            dietFilter.appendChild(opt);
          });
        }

        renderDashboard();
      } catch (err) {
        console.error("Error loading data:", err);
        const metaEl = document.getElementById("meta");
        metaEl.textContent = "Error loading data from Azure Function.";
      }
    }

    function getFilteredRecords() {
      if (!fullPayload) return [];

      const searchTerm = document
        .getElementById("dietSearch")
        .value.trim()
        .toLowerCase();

      const dietFilter = document.getElementById("dietFilter").value;
      const selected = dietFilter === "all" ? [] : [dietFilter];

      // First let Nara's helper filter by diet selection
      const base = filterByDiet(fullPayload.records, selected);

      // Then apply search filter
      return base.filter(r => {
        const diet = (r.Diet_type || "").toLowerCase();
        return !searchTerm || diet.includes(searchTerm);
      });
    }

    // ---------------------------
    // Chart rendering
    // ---------------------------
    function renderDashboard() {
      if (!fullPayload) return;

      const filtered = getFilteredRecords();

      // Metadata
      const metaEl = document.getElementById("meta");
      metaEl.textContent =
        `Dataset: ${fullPayload.datasetName} • ` +
        `Updated: ${new Date(fullPayload.fetchedAt).toLocaleString()} • ` +
        `Records: ${filtered.length}`;

      // JSON preview
      document.getElementById("jsonBox").textContent = JSON.stringify(
        filtered,
        null,
        2
      );

      const { labels, protein, carbs, fat } = toChartSeries(filtered);

      // Approximate calories (for pie + heatmap)
      const calories = protein.map(
        (p, i) => p * 4 + carbs[i] * 4 + fat[i] * 9
      );

      // Destroy existing charts so we can re-render
      [barChart, scatterChart, heatmapChart, pieChart].forEach(ch => {
        if (ch) ch.destroy();
      });

      const barCtx = document.getElementById("barChart");
      const scatterCtx = document.getElementById("scatterChart");
      const heatCtx = document.getElementById("heatmapChart");
      const pieCtx = document.getElementById("pieChart");

      if (barCtx) {
        barChart = new Chart(barCtx.getContext("2d"), {
          type: "bar",
          data: {
            labels,
            datasets: [
              { label: "Protein (g)", data: protein },
              { label: "Carbs (g)", data: carbs },
              { label: "Fat (g)", data: fat }
            ]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } },
            plugins: {
              title: { display: true, text: "Average Macros by Diet Type" }
            }
          }
        });
      }

      if (scatterCtx) {
        const scatterData = labels.map((name, i) => ({
          x: protein[i],
          y: carbs[i],
          label: name
        }));

        scatterChart = new Chart(scatterCtx.getContext("2d"), {
          type: "scatter",
          data: {
            datasets: [
              {
                label: "Protein vs Carbs",
                data: scatterData
              }
            ]
          },
          options: {
            responsive: true,
            parsing: false,
            scales: {
              x: { title: { display: true, text: "Protein (g)" } },
              y: { title: { display: true, text: "Carbs (g)" } }
            }
          }
        });
      }

      if (heatCtx) {
        const macroLoad = protein.map(
          (p, i) => p + carbs[i] + fat[i]
        );

        heatmapChart = new Chart(heatCtx.getContext("2d"), {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Total Macro Load (Protein + Carbs + Fat)",
                data: macroLoad
              }
            ]
          },
          options: {
            indexAxis: "y",
            responsive: true,
            scales: {
              x: { beginAtZero: true }
            }
          }
        });
      }

      if (pieCtx) {
        pieChart = new Chart(pieCtx.getContext("2d"), {
          type: "pie",
          data: {
            labels,
            datasets: [
              {
                label: "Estimated Calories",
                data: calories
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: "Estimated Calories by Diet Type" }
            }
          }
        });
      }
    }

    // ---------------------------
    // Pagination (simple visual)
    // ---------------------------
    function setupPagination() {
      const pages = document.querySelectorAll(".page-number");

      function setPage(page) {
        currentPage = page;
        pages.forEach(btn => {
          btn.classList.toggle(
            "active",
            Number(btn.dataset.page) === currentPage
          );
        });
        // For now pagination is visual only; dataset is small.
        // In a bigger app we would slice the records here.
      }

      pages.forEach(btn => {
        btn.addEventListener("click", () => setPage(Number(btn.dataset.page)));
      });

      document.getElementById("pagePrev").addEventListener("click", () => {
        if (currentPage > 1) setPage(currentPage - 1);
      });

      document.getElementById("pageNext").addEventListener("click", () => {
        if (currentPage < pages.length) setPage(currentPage + 1);
      });

      setPage(1);
    }

    // ---------------------------
    // Event wiring
    // ---------------------------
    function setupEvents() {
      document
        .getElementById("dietSearch")
        .addEventListener("input", () => renderDashboard());

      document
        .getElementById("dietFilter")
        .addEventListener("change", () => renderDashboard());

      document
        .getElementById("btnInsights")
        .addEventListener("click", () => loadData());

      // For assignment purposes, Recipes / Clusters reuse same data
      document
        .getElementById("btnRecipes")
        .addEventListener("click", () => loadData());

      document
        .getElementById("btnClusters")
        .addEventListener("click", () => loadData());
    }

    // ---------------------------
    // Init
    // ---------------------------
    loadData()
      .then(() => {
        setupEvents();
        setupPagination();
      })
      .catch(err => {
        console.error(err);
        alert("API error. See console for details.");
      });
  </script>
</body>
</html>
